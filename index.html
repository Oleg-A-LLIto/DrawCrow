<html>
<link rel="stylesheet" type="text/css" href="styles.css">
<link rel="icon" href="favicon.ico">
<title>DrawCrow</title>
<body>
<div class="logo"><img src="logo.png" style="margin-top: -4px; padding-right: 10px;">DrawCrow</div>
<div style="display: flex; text-align:center;">
	<div style="margin-left: auto; margin-right: auto; display: flex;">
		<div style="display: flex; flex-direction: column;">
			<div class="tool_button left_sidebar_button selected button" id="button_brush" onclick="set_tool('brush')">
				<img style="align-self: center;" src="icons/paint-brush.png">
			</div>
			<div class="tool_button left_sidebar_button button" id="button_fill" onclick="set_tool('fill')">
				<img style="align-self: center;" src="icons/color-fill-tool.png">
			</div>
			<div class="tool_button left_sidebar_button button" id="button_ruler" onclick="set_tool('ruler')">
				<img style="align-self: center;" src="icons/ruler-measurement.png">
			</div>
			<div class="tool_button left_sidebar_button button" id="button_eraser" onclick="set_tool('eraser')">
				<img style="align-self: center;" src="icons/eraser.png">
			</div>
			<div class="tool_button left_sidebar_button button" id="button_dropper" onclick="set_tool('dropper')">
				<img style="align-self: center;" src="icons/dropper.png">
			</div>
			<div class="left_sidebar_button button" onclick="cancel()">
				<img style="align-self: center;" src="icons/reply-arrow.png">
			</div>
		</div>
		<div style="width: 962px; height: 722px; overflow-y: auto; overflow-x: auto;">
			<canvas id="cl" class="ccl" width=960px height=720px onmousedown="action_start()" onmouseup="action_end()" onmouseleave="action_interrupted()" onmousemove="action_process()" style="border-style: solid; border-width: 1px; cursor: crosshair;" ></canvas>
		</div>
		<div style="display: flex; flex-direction: column;">
			<div class="right_sidebar">
				<div style="margin-left: auto; margin-right: auto; padding: 20px; text-align:right; display: flex; justify-content: space-around;">
					<div style="display: block; height: 128px;">
						<div style="width: 128px; height: 128px;">
							<div id="color_sample" style="width: 128px; height: 128px; background-color: #000000; position:  relative; z-index:3;">
							</div>	
							<div src="checkers.png" style="width:  128px; height: 128px; position:  relative; top: -128px; z-index:2; background-image: url('checkers.png'); background-repeat: no-repeat;">
							</div>
						</div>
						
						<clear>
						</clear>
					</div>
					<div style="display: flex; flex-direction: column; text-align: left; justify-content: space-around;">
						<div src="checkers.png" style="width:  128px; height: 12px; background-image: url('checkers.png'); background-repeat: no-repeat;">
							<input type="range" class="color_picker" id="red" style="width:128px; background: linear-gradient(to right, #000000, #FF0000);" min="0" max="255" value="0" onchange="update_color()">
						</div>
						<br>
						<div src="checkers.png" style="width:  128px; height: 12px; background-image: url('checkers.png'); background-repeat: no-repeat;">
							<input type="range" class="color_picker" id="green" style="width:128px; background: linear-gradient(to right, #000000, #00FF00);" min="0" max="255" value="0" onchange="update_color()">
						</div>
						<br>
						<div src="checkers.png" style="width:  128px; height: 12px; background-image: url('checkers.png'); background-repeat: no-repeat;">
							<input type="range" class="color_picker" id="blue" style="width:128px; background: linear-gradient(to right, #000000, #0000FF);" min="0" max="255" value="0" onchange="update_color()">
						</div>
						<br>
						<div src="checkers.png" style="width:  128px; height: 12px; background-image: url('checkers.png'); background-repeat: no-repeat;">
							<input type="range" class="color_picker" id="alpha" style="width:128px; background: linear-gradient(to right, #00000000, #000000FF);" min="0" max="255" value="255" step="0.01" onchange="update_color()">
						</div>
					</div>
				</div>
				<clear>
				</clear>
			</div>
			<div class="right_sidebar" style="height: 228px;">
				<div style="margin-left: auto; margin-right: auto; padding: 20px; text-align:left;">
					<div id="thickness_settings">
						Thickness:
						<br>
						<input type="range" id="thickness" min="2" max="64" step="1" value="2" style="width: 172px; margin:0px" onclick="update_properties('thickness')">
						<br>
						<br>
					</div>
					<div id="tolerance_settings">
						Tolerance:
						<br>
						<input type="range" id="tolerance" min="0" max="1" step="0.01" value="0.5" style="width: 172px; margin:0px" onclick="update_properties('tolerance')">
						<br>
						<br>
					</div>
					<label class="check_container">
						This one does nothing so far
						<input type="checkbox" id="asf" checked="true" onclick="">
						<span class="checkmark"></span>
					</label>
				</div>
			</div>
			<div class="right_sidebar">
				<div style="display: flex; justify-content: space-between; margin-bottom: 2px;">
					<div>
						<div class="layers_button button" onclick="new_layer()">
							<img src="icons/plus-square-line.png">
						</div>
					</div>
					<div>
						<div class="layers_button button unavailable" id="button_flatten" onclick="flatten_down()">
							<img src="icons/flatten.png">
						</div>
					</div>
					<div>
						<div class="layers_button button unavailable" id="button_layer_down" onclick="swap_down()">
							<img src="icons/arrow.png" style="-webkit-transform: scaleY(-1); transform: scaleY(-1);">
						</div>
					</div>
					<div>
						<div class="layers_button button unavailable" id="button_layer_up" onclick="swap_up()">
							<img src="icons/arrow.png">
						</div>
					</div>
				</div>
				<div id="layerslist" class="layers_scroll" style="display: flex; flex-direction: column;">
					<div class="layer_plate selected" id="plate_0" onclick="switch_to_layer(0)">
						<canvas class="thumbnail" id="thumb_0"></canvas>
						<div style="width:130px;">
							Background
							<input type="range" id="opacity_0" style="width:128px;" min="0" max="100" value="100" checked="true" onchange="update_layer_properties('opacity',0)">
						</div>
						<div style="width:72px;">
							<div style="display:flex; justify-content: space-around;">
								<label class="check_container layer_setting">
									<img src="icons/view.png">
									<input type="checkbox" id="visible_0" checked="true" onclick="update_layer_properties('visible',0)">
									<span class="checkmark"></span>
								</label>
								<img class="button layer_setting" style="align-self: center;" src="icons/delete.png" onclick="delete_layer(idToNum(0))">
							</div>
							<select id="mode_0"  onchange="update_layer_properties('mode',0)">
							  <option value="normal" selected>Normal</option>
							  <option value="add">Add</option>
							  <option value="dissolve">Dissolve</option>
							  <option value="negate">Negate</option>
							</select>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>
</body>
</html>

<script src="layer.js"></script>
<script src="rng.js"></script>

<script>
const width = 960;
const height = 720;
const twidth = 48;
const theight = 36;
let tool = "brush";
let curcol = new Color(0,0,0,255);
let seccol = "rgba(255,255,255,255)"
let layers = [];
let tol = 0.75;

let p = [];
let k = 0;
let thickness = 2;
let layer_increment = 1;
let activelayer = 0;
let newl = new Layer(0);
layers.push(newl);
let action_ongoing = false;

let Random = new RNG();

function reorder_plates(){
	const ll = document.getElementById("layerslist");
	const plates = document.getElementsByClassName("layer_plate");
	for(let i = layers.length-1; i >= 0; i--){
		for(let j = 0; j < plates.length; j++){
		    if(plates[j].id == ("plate_"+layers[i].id)){
				ll.append(plates[j]);
				break;
			}
		}
	}
}

function switch_to_layer(layer_id){
	if(event.target.classList.contains("layer_setting")){
		return;
	}
	activelayer = idToNum(layer_id);
	plates = document.getElementsByClassName("layer_plate");
	for(let i = 0; i<plates.length; i++){
	    if(plates[i].id == ("plate_"+layers[activelayer].id)){
			plates[i].classList.add("selected");
		}
		else{
			plates[i].classList.remove("selected");
		}
	}
	layers[activelayer].update_color();
	update_layer_buttons();
}

function idToNum(layer_id){
	for(let i = 0; i < layers.length; i++){
		if (layers[i].id == layer_id){
			return i;
		}
	}
}

function new_layer(){
	const layer_id = layer_increment++;
	let newplate = document.createElement("div");
	newplate.setAttribute("onclick","switch_to_layer("+layer_id+");");
	newplate.classList.add("layer_plate");
	newplate.setAttribute("id","plate_"+layer_id);
	newplate.innerHTML += '<canvas class="thumbnail" id="thumb_'+layer_id+'"></canvas><div style="width:130px;">	Layer'+layer_id+'	<input type="range" id="opacity_'+layer_id+'" style="width:128px;" min="0" max="100" value="100" checked="true" onchange="update_layer_properties(\'opacity\','+layer_id+')"></div><div style="width:72px;">	<div style="display:flex; justify-content: space-around;">		<label class="check_container">			<img src="icons/view.png">			<input type="checkbox" id="visible_'+layer_id+'" checked="true" onclick="update_layer_properties(\'visible\','+layer_id+')">			<span class="checkmark"></span>		</label>		<img class="button layer_setting" style="align-self: center;" src="icons/delete.png" onclick="delete_layer(idToNum('+layer_id+'))">	</div>	<select id="mode_'+layer_id+'" onchange="update_layer_properties(\'mode\','+layer_id+')">	  <option value="normal" selected>Normal</option>	  <option value="add">Add</option>	  <option value="dissolve">Dissolve</option>	  <option value="negate">Negate</option>	</select></div>';
	const ll = document.getElementById("layerslist");
	//ll.insertBefore(document.createElement("br"), ll.firstChild);
	ll.insertBefore(newplate, ll.firstChild);
	layers.push(new Layer(layer_id));
	switch_to_layer(layer_id);
}

function flatten_image(){
	const canvas = document.getElementById('cl');
	const ctx = canvas.getContext('2d');
	ctx.clearRect(0, 0, width, height);
	let imgData = ctx.getImageData(0, 0, width, height);
	let data = imgData.data;
	for(i = 0; i < layers.length; i++){
		if(layers[i].visible==false)
			continue;
		data2 = layers[i].getdata().data;
		data = merge(data, data2, layers[i].opacity, layers[i].mode);
		//imgData.data = data;
	}
	ctx.putImageData(imgData, 0, 0);
}

function flatten_down(){
	if(activelayer>0){
		layers[activelayer].merge_with(layers[activelayer-1]);
		delete_layer(activelayer);
		layers[activelayer].update_thumbnail();
		update_layer_buttons();
	}
}

function merge(data, data2, op2, mode){
	Random.set(0);
	for (var j = 0; j < data.length; j += 4) {
		const rand = Random.get();
		const data2op = data2[j+3] * (op2/100);
		let culling = 255 - (data2op + data[j+3]);
		if (culling > 0) culling = 0;
		const ratio = data2op/(data2op + data[j+3] + culling);
		data[j] = calculate_color(data[j], data2[j], data[j+3], data2op, ratio, mode, rand); // red
		data[j+1] = calculate_color(data[j+1], data2[j+1], data[j+3], data2op, ratio, mode, rand); //green
		data[j+2] =calculate_color(data[j+2], data2[j+2], data[j+3], data2op, ratio, mode, rand);  //blue
		data[j+3] = Math.min(data2op + data[j+3], 255);
	}
	return data;
}

function calculate_color(pix1, pix2, alpha1, alpha2, ratio, mode, rand){
	switch(mode){
		case('normal'):
			return pix2*ratio + pix1*(1-ratio);
		case('negate'):
			return pix1 * (alpha1/255) - pix2 * (alpha2/255);
		case('dissolve'):
			return (rand < ratio) ? pix2 : pix1;
		case('add'):
			return pix1 * (alpha1/255) + pix2 * (alpha2/255);
	}
}


function update_color(){
	const red = document.getElementById('red').value;
	const green = document.getElementById('green').value;
	const blue = document.getElementById('blue').value;
	const alpha = document.getElementById('alpha').value;
	curcol = new Color(red,green,blue,alpha);
	document.getElementById('color_sample').style.background = curcol.toRGBA(); 
	document.getElementById('red').style.background = "linear-gradient(to right, rgba(0,"+green+","+blue+",1), rgba(255,"+green+","+blue+",1))";
	document.getElementById('green').style.background = "linear-gradient(to right, rgba("+red+",0,"+blue+",1), rgba("+red+",255,"+blue+",1))";
	document.getElementById('blue').style.background = "linear-gradient(to right, rgba("+red+","+green+",0,1), rgba("+red+","+green+",255,1))";
	document.getElementById('alpha').style.background = "linear-gradient(to right, rgba("+red+","+green+","+blue+",0), rgba("+red+","+green+","+blue+",1))";
	layers[activelayer].update_color();
	const canvas = document.getElementById('cl');
	const ctx = canvas.getContext('2d');
	ctx.strokeStyle = curcol.toRGBA();
	ctx.fillStyle = curcol.toRGBA();
}

/*
function update_color(){
	alert(curcol);
	curcol = document.getElementById('col1').value + "FF";
	alert(curcol);
	seccol = document.getElementById('col2').value;
	layers[activelayer].update_color();
}
*/

function action_start(){
	action_ongoing = true;
	layers[activelayer].save();
	switch (tool){
		case "ruler":
			var canvas = document.getElementById('cl');
			var ctx = canvas.getContext('2d');
			var rect = canvas.getBoundingClientRect();
			layers[activelayer].ruler_start(event.clientX - rect.left,event.clientY - rect.top);
			break;
		case "eraser":
			var canvas = document.getElementById('cl');
			var ctx = canvas.getContext('2d');
			var rect = canvas.getBoundingClientRect();
			layers[activelayer].erase(event.clientX - rect.left,event.clientY - rect.top);
			flatten_image();
			break;
		case "brush":
			var canvas = document.getElementById('cl');
			var ctx = canvas.getContext('2d');
			var rect = canvas.getBoundingClientRect();
			layers[activelayer].draw_pen(event.clientX - rect.left,event.clientY - rect.top);
			if(!layers[activelayer].simplified_preview)
				flatten_image();
			break;
		case "dropper":
			var canvas = document.getElementById('cl');
			var ctx = canvas.getContext('2d');
			var rect = canvas.getBoundingClientRect();
			layers[activelayer].sample(event.clientX - rect.left,event.clientY - rect.top);
			break;
	}
}

function cancel(){
	layers[activelayer].load();
	flatten_image();
}

function action_process(){
	if (action_ongoing){
		switch (tool){
			case "brush":
				var canvas = document.getElementById('cl');
				var ctx = canvas.getContext('2d');
				var rect = canvas.getBoundingClientRect();
				layers[activelayer].draw_pen(event.clientX - rect.left,event.clientY - rect.top);
				if(!layers[activelayer].simplified_preview)
					flatten_image();
				break;
			case "ruler":
				var canvas = document.getElementById('cl');
				var ctx = canvas.getContext('2d');
				var rect = canvas.getBoundingClientRect();
				layers[activelayer].ruler_render(event.clientX - rect.left,event.clientY - rect.top);
				break;
			case "eraser":
				var canvas = document.getElementById('cl');
				var ctx = canvas.getContext('2d');
				var rect = canvas.getBoundingClientRect();
				layers[activelayer].erase(event.clientX - rect.left,event.clientY - rect.top);
				flatten_image();
				break;
			case "dropper":
				var canvas = document.getElementById('cl');
				var ctx = canvas.getContext('2d');
				var rect = canvas.getBoundingClientRect();
				layers[activelayer].sample(event.clientX - rect.left,event.clientY - rect.top);
				break;
		}
	}
}


function action_end(){
	if (action_ongoing){
		action_ongoing = false;
		switch (tool){
			case "ruler":
				var canvas = document.getElementById('cl');
				var ctx = canvas.getContext('2d');
				var rect = canvas.getBoundingClientRect();
				layers[activelayer].ruler_end(event.clientX - rect.left,event.clientY - rect.top);
				//ctx.putImageData(layers[activelayer].getdata(), 0, 0);
				flatten_image();
				break;
			case "brush":
				layers[activelayer].clear_pen();
				flatten_image();
				break;
			case "fill":
				var canvas = document.getElementById('cl');
				var ctx = canvas.getContext('2d');
				var rect = canvas.getBoundingClientRect();
				layers[activelayer].fill(event.clientX - rect.left,event.clientY - rect.top);
				//ctx.putImageData(layers[activelayer].getdata(), 0, 0);
				flatten_image();
				break;
			case "dropper":
				var canvas = document.getElementById('cl');
				var ctx = canvas.getContext('2d');
				var rect = canvas.getBoundingClientRect();
				layers[activelayer].sample(event.clientX - rect.left,event.clientY - rect.top);
				break;
		}
		layers[activelayer].update_thumbnail()
	}
}

function action_interrupted(){
	action_ongoing = false;
	switch (tool){
		case "ruler":
		case "brush":
			layers[activelayer].clear_pen();
			break;
	}
	flatten_image();
}

function set_tool(tl){
	tool = tl;
	tools = document.getElementsByClassName("tool_button");
	for(let i = 0; i<tools.length; i++){
		if(tools[i].id == ("button_"+tool)){
			tools[i].classList.add("selected");
		}
		else{
			tools[i].classList.remove("selected");
		}
	}
}

function set_point()
{
	if(k%2==1)
		return;
	var canvas = document.getElementById('cl');
	var ctx = canvas.getContext('2d');
	var rect = canvas.getBoundingClientRect();
	if(k==4){
		k = 0;
		p = [];
	}
	var mousex = event.clientX - rect.left;
	var mousey = event.clientY - rect.top;
	p[k] = {x: mousex, y: mousey};
	k++;
	ctx.fillStyle = "rgb(0,0,0)";
	ctx.fillRect(mousex - 8, mousey - 8, 16, 16);
	ctx.fillStyle = "rgb(256,48,48)";
	ctx.fillRect(mousex - 6, mousey - 6, 12, 12);
}

function set_pivot() {
	if((k%2==0)||k>=4)
		return;
	var canvas = document.getElementById('cl');
	var ctx = canvas.getContext('2d');
	var rect = canvas.getBoundingClientRect();
	var mousex = event.clientX - rect.left;
	var mousey = event.clientY - rect.top;
	p[k] = {x: mousex, y: mousey};
	ctx.beginPath();    
	ctx.moveTo(p[k-1].x, p[k-1].y);   
	ctx.lineTo(mousex, mousey); 
	ctx.stroke(); 
	ctx.fillStyle = "rgb(0,0,0)";
	ctx.fillRect(mousex - 8, mousey - 8, 16, 16);
	ctx.fillStyle = "rgb(48,256,48)";
	ctx.fillRect(mousex - 6, mousey - 6, 12, 12);
	k++;
	if(k==4){
		draw_bezier();
	}
}

function draw_bezier(){
	var canvas = document.getElementById('cl');
	var ctx = canvas.getContext('2d');
	ctx.beginPath();    
	ctx.moveTo(p[0].x, p[0].y);   
	var r0 = p[0];
	var r1;
	ctx.fillStyle = "rgb(0,0,0)";
	for(var i = 1; i<=number; i++){
		var r1 = calc_for_point(i);
		ctx.lineTo(r1.x, r1.y); 
		ctx.fillRect(r1.x-2,r1.y-2,4,4);
		r0 = r1;
	}
	ctx.stroke(); 
}

function update_properties(prop){
	switch(prop){
		case('thickness'):
			thickness = document.getElementById('thickness').value;
			break;
		case('tolerance'):
			tol = document.getElementById('tolerance').value;
			break;
	}
}

function update_layer_properties(prop,layer_id){
	layers.forEach(function(lay) {
		if (lay.id == layer_id) {
			switch(prop){
				case('opacity'):
					lay.opacity = document.getElementById('opacity_'+layer_id).value;
					break;
				case('visible'):
					lay.visible = document.getElementById('visible_'+layer_id).checked;
					break;
				case('mode'):
					lay.mode = document.getElementById('mode_'+layer_id).value;
					break;
			}
			flatten_image();
		}
	})
}

function update_layer_buttons(){
	if(activelayer == layers.length-1){
		document.getElementById("button_layer_up").classList.add("unavailable");
	}
	else{
		document.getElementById("button_layer_up").classList.remove("unavailable");
	}
	if(activelayer == 0){
		document.getElementById("button_layer_down").classList.add("unavailable");
		document.getElementById("button_flatten").classList.add("unavailable");
	}
	else{
		document.getElementById("button_layer_down").classList.remove("unavailable");
		document.getElementById("button_flatten").classList.remove("unavailable");
	}
}


function swap_up(){
	if(activelayer<layers.length-1){
		let temp = layers[activelayer + 1];
		layers[activelayer + 1] = layers[activelayer];
		layers[activelayer] = temp;	
		activelayer += 1;
		reorder_plates();
		update_layer_buttons();
		flatten_image();
	}
}

function swap_down(){
	if(activelayer>0){
		let temp = layers[activelayer - 1];
		layers[activelayer - 1] = layers[activelayer];
		layers[activelayer] = temp;	
		activelayer -= 1;
		reorder_plates();
		update_layer_buttons();
		flatten_image();
	}
}


function delete_layer(laynum){
	const layer_id = layers[laynum].id;
	temp = layers.splice(laynum,1);
	delete temp;
	document.getElementById('plate_'+layer_id).remove();
	if(activelayer==laynum){
		activelayer = ((laynum > 0) ? laynum-1 : laynum);
		layers[activelayer].update_color();
		document.getElementById('plate_'+layers[activelayer].id).classList.add("selected");
	}
	flatten_image();
}
</script>
